{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SAT Prep Reading Comprehension</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f5f5f5;
            min-height: 100vh;
            padding: 20px;
            color: #000;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        header {
            background: white;
            border-radius: 10px;
            padding: 24px 30px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            border: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo {
            text-decoration: none;
            color: #3498DB;
            display: flex;
            align-items: center;
            gap: 16px;
            transition: transform 0.2s ease;
        }
        
        .logo:hover {
            transform: scale(1.02);
        }
        
        .logo img {
            height: 60px;
            width: auto;
            display: block;
        }
        
        .logo span {
            font-size: 32px;
            font-weight: 700;
            margin-left: 0;
            letter-spacing: -0.5px;
        }
        
        .auth-section {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: #3498DB;
            color: #fff;
            font-weight: 500;
        }
        
        .btn-primary:hover {
            background: #2980B9;
        }
        
        .btn-secondary {
            background: #e0e0e0;
            color: #000;
            font-weight: 500;
        }
        
        .btn-secondary:hover {
            background: #d0d0d0;
        }
        
        .btn-success {
            background: #3498DB;
            color: #fff;
            font-weight: 500;
        }
        
        .btn-success:hover {
            background: #2980B9;
        }
        
        .main-content {
            display: grid;
            grid-template-columns: 1fr 300px;
            gap: 20px;
        }
        
        .passages-section {
            background: white;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            border: 1px solid #e0e0e0;
        }
        
        .passages-section h2 {
            color: #3498DB;
            font-size: 28px;
            font-weight: 600;
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 2px solid #3498DB;
        }
        
        .sidebar {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            border: 1px solid #e0e0e0;
            height: fit-content;
        }
        
        .passage-card {
            border: 1px solid #d0d0d0;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 16px;
            cursor: pointer;
            transition: all 0.2s ease;
            background: #ffffff;
        }
        
        .passage-card:hover {
            box-shadow: 0 4px 12px rgba(52, 152, 219, 0.2);
            transform: translateY(-2px);
            border-color: #3498DB;
        }
        
        .passage-card h3 {
            color: #000;
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 8px;
        }
        
        .passage-card p {
            color: #666;
            font-size: 14px;
            margin: 0;
        }
        
        .passage-card.premium {
            border-left: 4px solid #3498DB;
        }
        
        .premium-badge {
            display: inline-block;
            background: #3498DB;
            color: #fff;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            margin-left: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .passage-detail-section {
            background: white;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            border: 1px solid #e0e0e0;
        }
        
        .passage-content {
            background: #f9f9f9;
            border-radius: 8px;
            padding: 25px;
            margin-bottom: 30px;
            line-height: 1.8;
            font-size: 16px;
            color: #000;
            border: 1px solid #e0e0e0;
            white-space: pre-wrap;
        }
        
        .passage-content-sat {
            background: #f9f9f9;
            border-radius: 8px;
            padding: 25px;
            margin-bottom: 30px;
            border: 1px solid #e0e0e0;
            font-family: "Minion Pro", "Minion", "Times New Roman", "Times", serif;
            font-size: 16px;
            line-height: 1.6;
            color: #000;
        }
        
        .passage-columns {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            column-gap: 40px;
        }
        
        .passage-column {
            width: 100%;
        }
        
        .passage-line {
            font-family: "Minion Pro", "Minion", "Times New Roman", "Times", serif;
            font-size: 15px;
            line-height: 1.5;
            white-space: pre;
            margin: 0;
            padding: 0;
        }
        
        .passage-line-numbered {
            display: flex;
            align-items: flex-start;
            margin: 0;
            padding: 0;
        }
        
        .line-number {
            color: #666;
            font-size: 11px;
            font-weight: bold;
            margin-right: 8px;
            min-width: 25px;
            text-align: right;
            padding-top: 2px;
            font-family: "Myriad Pro", "Myriad", "Arial", sans-serif;
        }
        
        .line-text {
            flex: 1;
            font-family: "Minion Pro", "Minion", "Times New Roman", "Times", serif;
            font-size: 15px;
            line-height: 1.5;
            white-space: pre;
        }
        
        .questions-columns {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        @media (max-width: 1024px) {
            .passage-columns,
            .questions-columns {
                grid-template-columns: 1fr;
            }
        }
        
        .question-card {
            border: 1px solid #d0d0d0;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            background: #ffffff;
            font-family: "Myriad Pro", "Myriad", "Arial", sans-serif;
        }
        
        .question-card h4 {
            color: #000;
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
            font-family: "Myriad Pro", "Myriad", "Arial", sans-serif;
        }
        
        .question-card p {
            font-family: "Myriad Pro", "Myriad", "Arial", sans-serif;
        }
        
        .option {
            display: flex;
            align-items: flex-start;
            padding: 12px;
            margin-bottom: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            background: #ffffff;
            font-family: "Myriad Pro", "Myriad", "Arial", sans-serif;
        }
        
        .option:hover {
            border-color: #3498DB;
            background: #f0f8ff;
        }
        
        .option.selected {
            border-color: #3498DB;
            background: #e3f2fd;
        }
        
        .option.correct {
            border-color: #27ae60;
            background: #d4edda;
        }
        
        .option.incorrect {
            border-color: #e74c3c;
            background: #f8d7da;
        }
        
        .option input[type="radio"] {
            margin-right: 12px;
            margin-top: 2px;
            cursor: pointer;
        }
        
        .option-label {
            flex: 1;
            color: #000;
            font-size: 15px;
            font-family: "Myriad Pro", "Myriad", "Arial", sans-serif;
        }
        
        .explanation {
            margin-top: 15px;
            padding: 15px;
            background: #f0f8ff;
            border-left: 4px solid #3498DB;
            border-radius: 4px;
            color: #000;
            font-size: 14px;
            line-height: 1.6;
            font-family: "Myriad Pro", "Myriad", "Arial", sans-serif;
        }
        
        .results-summary {
            background: #f9f9f9;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid #e0e0e0;
            font-family: "Myriad Pro", "Myriad", "Arial", sans-serif;
        }
        
        .results-summary h3 {
            color: #000;
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 15px;
            font-family: "Myriad Pro", "Myriad", "Arial", sans-serif;
        }
        
        .score {
            font-size: 32px;
            font-weight: 700;
            color: #3498DB;
            margin: 10px 0;
            font-family: "Myriad Pro", "Myriad", "Arial", sans-serif;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: white;
            border-radius: 10px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            border: 1px solid #e0e0e0;
        }
        
        .modal-content h2 {
            color: #3498DB;
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 2px solid #3498DB;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #000;
        }
        
        .form-group input {
            width: 100%;
            padding: 12px;
            border: 1px solid #d0d0d0;
            border-radius: 6px;
            font-size: 14px;
            background: #ffffff;
            color: #000;
        }
        
        .form-group input:focus {
            outline: none;
            border-color: #3498DB;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }
        
        .error {
            color: #dc3545;
            font-size: 14px;
            margin-top: 5px;
        }
        
        .user-info {
            padding: 16px;
            background: #f5f5f5;
            border-radius: 8px;
            margin-bottom: 15px;
            border: 1px solid #e0e0e0;
        }
        
        .user-info strong {
            color: #000;
            font-weight: 600;
        }
        
        .subscription-info {
            padding: 16px;
            background: rgba(52, 152, 219, 0.1);
            border-radius: 8px;
            border: 1px solid rgba(52, 152, 219, 0.3);
        }
        
        .subscription-info strong {
            color: #000;
            font-weight: 600;
        }
        
        .word-of-day {
            padding: 20px;
            background: white;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        
        .word-of-day h3 {
            color: #3498DB;
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 16px;
            padding-bottom: 10px;
            border-bottom: 2px solid #3498DB;
        }
        
        .word-of-day .word {
            font-size: 24px;
            font-weight: 700;
            color: #000;
            margin-bottom: 12px;
        }
        
        .word-of-day .definition {
            color: #333;
            font-size: 14px;
            line-height: 1.6;
            margin-bottom: 12px;
        }
        
        .word-of-day .synonyms {
            margin-bottom: 12px;
        }
        
        .word-of-day .synonyms-label {
            font-weight: 600;
            color: #000;
            font-size: 13px;
            margin-bottom: 6px;
        }
        
        .word-of-day .synonym-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }
        
        .word-of-day .synonym-tag {
            background: rgba(52, 152, 219, 0.1);
            color: #3498DB;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
            border: 1px solid rgba(52, 152, 219, 0.3);
        }
        
        .word-of-day .example {
            margin-top: 12px;
            padding: 12px;
            background: #f5f5f5;
            border-radius: 6px;
            border-left: 3px solid #3498DB;
        }
        
        .word-of-day .example-label {
            font-weight: 600;
            color: #000;
            font-size: 13px;
            margin-bottom: 6px;
        }
        
        .word-of-day .example-sentence {
            color: #333;
            font-size: 13px;
            line-height: 1.6;
            font-style: italic;
        }
        
        .word-of-day .loading {
            text-align: center;
            color: #666;
            padding: 20px;
        }
        
        .hidden {
            display: none;
        }
        
        /* Landing Page Styles */
        .landing-page {
            display: block;
            animation: fadeIn 0.6s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .landing-page ~ header,
        .landing-page header {
            display: none;
        }
        
        body:has(.landing-page:not([style*="display: none"])) header {
            display: none;
        }
        
        /* Brand Colors */
        :root {
            --navy: #1B2A4A;
            --gold: #F4C441;
            --blue: #3498DB;
        }
        
        .landing-hero {
            background: white;
            border-radius: 16px;
            padding: 100px 40px;
            text-align: center;
            margin-bottom: 60px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            border: 1px solid #e0e0e0;
            animation: fadeIn 0.8s ease-in;
        }
        
        .hero-logo {
            margin-bottom: 24px;
        }
        
        .hero-logo img {
            height: 120px;
            width: auto;
            display: block;
            margin: 0 auto;
        }
        
        .hero-subtitle {
            font-size: 20px;
            color: var(--navy);
            font-weight: 500;
            margin-bottom: 32px;
            font-style: italic;
        }
        
        .landing-hero h1 {
            font-size: 48px;
            font-weight: 700;
            color: #000;
            margin-bottom: 24px;
            line-height: 1.2;
        }
        
        .landing-hero p {
            font-size: 19px;
            color: #555;
            margin-bottom: 50px;
            line-height: 1.7;
            max-width: 720px;
            margin-left: auto;
            margin-right: auto;
        }
        
        .hero-cta {
            margin-top: 50px;
            padding-top: 50px;
            border-top: 2px solid #f0f0f0;
        }
        
        .hero-cta h2 {
            color: var(--navy);
            font-size: 32px;
            font-weight: 600;
            margin-bottom: 16px;
        }
        
        .hero-cta p {
            font-size: 17px;
            color: #666;
            margin-bottom: 32px;
        }
        
        .btn-large {
            padding: 18px 40px;
            font-size: 18px;
            font-weight: 600;
            border-radius: 12px;
            background: var(--navy);
            color: white;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(27, 42, 74, 0.2);
        }
        
        .btn-large:hover {
            transform: scale(1.03) translateY(-2px);
            box-shadow: 0 6px 20px rgba(27, 42, 74, 0.3);
            background: #152238;
        }
        
        /* Product Preview Section */
        .preview-section {
            margin-bottom: 80px;
        }
        
        .preview-section h3 {
            text-align: center;
            font-size: 36px;
            font-weight: 700;
            color: var(--navy);
            margin-bottom: 50px;
        }
        
        .preview-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 30px;
            margin-bottom: 60px;
        }
        
        .preview-card {
            background: white;
            border-radius: 16px;
            padding: 32px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.1);
            border: 1px solid #e8e8e8;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }
        
        .preview-card:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 8px 24px rgba(0,0,0,0.15);
        }
        
        .preview-card-icon {
            font-size: 56px;
            margin-bottom: 20px;
        }
        
        .preview-card h4 {
            color: var(--navy);
            font-size: 22px;
            font-weight: 600;
            margin-bottom: 12px;
        }
        
        .preview-card p {
            color: #666;
            font-size: 15px;
            line-height: 1.6;
        }
        
        /* Why Keuwi Section */
        .why-keuwi {
            background: linear-gradient(135deg, rgba(27, 42, 74, 0.03) 0%, rgba(52, 152, 219, 0.03) 100%);
            border-radius: 16px;
            padding: 50px 40px;
            margin-bottom: 80px;
        }
        
        .why-keuwi h3 {
            text-align: center;
            font-size: 32px;
            font-weight: 700;
            color: var(--navy);
            margin-bottom: 40px;
        }
        
        .differentiators {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 16px;
        }
        
        .differentiator-pill {
            background: white;
            color: var(--navy);
            padding: 12px 24px;
            border-radius: 30px;
            font-size: 15px;
            font-weight: 500;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            border: 2px solid #e8e8e8;
            transition: all 0.2s ease;
        }
        
        .differentiator-pill:hover {
            border-color: var(--gold);
            background: rgba(244, 196, 65, 0.1);
            transform: translateY(-2px);
        }
        
        .differentiator-pill .pill-icon {
            margin-right: 8px;
            color: var(--gold);
        }
        
        /* Feature Cards - Enhanced */
        .landing-features {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 30px;
            margin-bottom: 80px;
        }
        
        .feature-card {
            background: linear-gradient(135deg, rgba(52, 152, 219, 0.02) 0%, rgba(255, 255, 255, 1) 100%);
            border-radius: 16px;
            padding: 40px 32px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.1);
            border: 1px solid #e8e8e8;
            text-align: center;
            transition: all 0.3s ease;
        }
        
        .feature-card:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 8px 24px rgba(0,0,0,0.15);
        }
        
        .feature-card h3 {
            color: var(--navy);
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 16px;
        }
        
        .feature-card p {
            color: #555;
            font-size: 16px;
            line-height: 1.7;
        }
        
        .feature-icon {
            font-size: 64px;
            margin-bottom: 24px;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1));
        }
        
        /* Mobile Responsiveness */
        @media (max-width: 768px) {
            .landing-hero {
                padding: 60px 24px;
            }
            
            .landing-hero h1 {
                font-size: 36px;
            }
            
            .preview-cards {
                grid-template-columns: 1fr;
            }
            
            .differentiators {
                overflow-x: auto;
                flex-wrap: nowrap;
                justify-content: flex-start;
                padding-bottom: 10px;
                -webkit-overflow-scrolling: touch;
            }
            
            .differentiator-pill {
                flex-shrink: 0;
            }
            
            .landing-features {
                grid-template-columns: 1fr;
            }
            
            .preview-section h3,
            .why-keuwi h3 {
                font-size: 28px;
            }
        }
        
        .passages-view {
            display: none;
        }
        
        .view-toggle {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .view-toggle button {
            padding: 8px 16px;
            font-size: 14px;
        }
        
        .view-toggle button.active {
            background: #3498DB;
            color: white;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <a href="#" class="logo" onclick="showLanding(); return false;">
                <img src="{% static 'web/images/keuvi.png' %}" alt="Keuvi Logo">
                <span>SAT Passages</span>
            </a>
            <div class="auth-section" id="authSection">
                <button class="btn btn-primary" onclick="showLoginModal()">Login</button>
                <button class="btn btn-secondary" onclick="showRegisterModal()">Register</button>
            </div>
        </header>
        
        <!-- Landing Page -->
        <div class="landing-page" id="landingPage">
            <div class="landing-hero">
                <div class="hero-logo">
                    <img src="{% static 'web/images/keuvi.png' %}" alt="Keuvi Logo">
                </div>
                <p class="hero-subtitle">Your SAT reading wingman</p>
                <h1>Master SAT Reading Comprehension</h1>
                <p>Level up your reading skills with expertly crafted passages and questions that mirror the real SAT. Start free, unlock premium content when you're ready to go deeper.</p>
                <div class="hero-cta">
                    <h2>Ready to Start Practicing?</h2>
                    <p>Browse our collection of reading passages and begin your SAT prep journey today.</p>
                    <button class="btn-large" onclick="showPassages()">Try a Free Passage</button>
                </div>
            </div>
            
            <!-- Product Preview Section -->
            <div class="preview-section">
                <h3>See What's Inside</h3>
                <div class="preview-cards">
                    <div class="preview-card" onclick="showPassages()">
                        <div class="preview-card-icon">üìñ</div>
                        <h4>Sample Passage</h4>
                        <p>Realistic SAT-style reading passages covering diverse topics and difficulty levels</p>
                    </div>
                    <div class="preview-card" onclick="showPassages()">
                        <div class="preview-card-icon">‚ùì</div>
                        <h4>Practice Questions</h4>
                        <p>Multiple-choice questions with detailed explanations to help you understand every answer</p>
                    </div>
                    <div class="preview-card" onclick="showPassages()">
                        <div class="preview-card-icon">üìä</div>
                        <h4>Track Progress</h4>
                        <p>Monitor your performance and see improvement over time with detailed analytics</p>
                    </div>
                </div>
            </div>
            
            <!-- Why Keuwi Section -->
            <div class="why-keuwi">
                <h3>Why Keuwi?</h3>
                <div class="differentiators">
                    <div class="differentiator-pill">
                        <span class="pill-icon">‚úì</span> Realistic SAT-style passages
                    </div>
                    <div class="differentiator-pill">
                        <span class="pill-icon">‚úì</span> Smart explanations
                    </div>
                    <div class="differentiator-pill">
                        <span class="pill-icon">‚úì</span> Adaptive difficulty
                    </div>
                    <div class="differentiator-pill">
                        <span class="pill-icon">‚úì</span> Free to start
                    </div>
                    <div class="differentiator-pill">
                        <span class="pill-icon">‚úì</span> Updated weekly
                    </div>
                </div>
            </div>
            
            <!-- Feature Cards -->
            <div class="landing-features">
                <div class="feature-card">
                    <div class="feature-icon">üìö</div>
                    <h3>Extensive Passage Library</h3>
                    <p>Access a growing collection of reading passages covering diverse topics and difficulty levels.</p>
                </div>
                <div class="feature-card">
                    <div class="feature-icon">‚ú®</div>
                    <h3>Free & Premium Content</h3>
                    <p>Start with free passages, then unlock premium content for advanced practice and detailed explanations.</p>
                </div>
                <div class="feature-card">
                    <div class="feature-icon">üîÑ</div>
                    <h3>Regular Updates</h3>
                    <p>New passages and content added regularly to keep your practice fresh and challenging.</p>
                </div>
            </div>
        </div>
        
        <!-- Passages View -->
        <div class="passages-view" id="passagesView">
            <div class="view-toggle">
                <button class="btn btn-secondary active" onclick="showPassages()">Passages</button>
                <button class="btn btn-secondary" onclick="showLanding()">Home</button>
            </div>
            
            <div class="main-content">
                <div class="content-column">
                    <!-- Lessons List View -->
                    <div class="passages-section" id="lessonsListSection" style="margin-bottom: 40px;">
                        <h2>Lessons</h2>
                        <div id="lessonsList"></div>
                    </div>
                    
                    <!-- Writing Sections List View -->
                    <div class="passages-section" id="writingSectionsListSection" style="margin-bottom: 40px;">
                        <h2>Writing Sections</h2>
                        <div id="writingSectionsList"></div>
                    </div>
                    
                    <!-- Passages List View -->
                    <div class="passages-section" id="passagesListSection">
                        <h2>Reading Passages</h2>
                        <div id="passagesList"></div>
                    </div>
                    
                    <!-- Passage/Lesson Detail View -->
                    <div class="passage-detail-section" id="passageDetailSection" style="display: none;">
                        <div style="margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center;">
                            <button class="btn btn-secondary" onclick="backToPassagesList()">‚Üê Back</button>
                            <span id="attemptHistoryButtonContainer"></span>
                        </div>
                        <div id="passageContent"></div>
                        <div id="questionsContainer"></div>
                        <div id="submitSection" style="margin-top: 30px;">
                            <button class="btn btn-primary" onclick="submitAnswers()" id="submitBtn">Submit Answers</button>
                        </div>
                        <div id="resultsSection" style="display: none; margin-top: 30px;"></div>
                    </div>
                </div>
                
                <div class="sidebar">
                    <div class="word-of-day" id="wordOfDay">
                        <h3>Word of the Day</h3>
                        <div class="loading">Loading...</div>
                    </div>
                    
                    <div id="userInfo" class="hidden">
                        <div class="user-info">
                            <strong>Logged in as:</strong><br>
                            <span id="userEmail"></span>
                        </div>
                        <div class="subscription-info" id="subscriptionInfo">
                            <strong>Subscription:</strong><br>
                            <span id="subscriptionStatus">Free</span><br>
                            <button class="btn btn-success" onclick="upgradeToPremium()" style="margin-top: 10px; width: 100%;">
                                Upgrade to Premium ($5/month)
                            </button>
                        </div>
                        <button class="btn btn-secondary" onclick="logout()" style="margin-top: 10px; width: 100%;">
                            Logout
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Login Modal -->
    <div id="loginModal" class="modal">
        <div class="modal-content">
            <h2>Login</h2>
            <form id="loginForm" onsubmit="handleLogin(event)">
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" name="email" required>
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" name="password" required>
                </div>
                <div id="loginError" class="error"></div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">Login</button>
                <button type="button" class="btn btn-secondary" onclick="closeModal('loginModal')" style="width: 100%; margin-top: 10px;">Cancel</button>
            </form>
        </div>
    </div>
    
    <!-- Register Modal -->
    <div id="registerModal" class="modal">
        <div class="modal-content">
            <h2>Register</h2>
            <form id="registerForm" onsubmit="handleRegister(event)">
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" name="email" required>
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" name="password" required minlength="8">
                </div>
                <div id="registerError" class="error"></div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">Register</button>
                <button type="button" class="btn btn-secondary" onclick="closeModal('registerModal')" style="width: 100%; margin-top: 10px;">Cancel</button>
            </form>
        </div>
    </div>
    
    <script>
        const API_BASE = '/api/v1';
        let authToken = localStorage.getItem('authToken');
        let currentUser = null;
        
        // Always start on landing page
        showLanding();
        
        // Check if user is logged in on load (but stay on landing page)
        if (authToken) {
            checkAuth();
        }
        
        // Load word of the day
        loadWordOfDay();
        
        function showLanding() {
            document.getElementById('landingPage').style.display = 'block';
            document.getElementById('passagesView').style.display = 'none';
            // Hide header on landing page
            document.querySelector('header').style.display = 'none';
            // Update toggle buttons
            document.querySelectorAll('.view-toggle button').forEach(btn => {
                btn.classList.remove('active');
            });
        }
        
        function showPassages() {
            document.getElementById('landingPage').style.display = 'none';
            document.getElementById('passagesView').style.display = 'block';
            // Show header on passages view
            document.querySelector('header').style.display = 'flex';
            // Update toggle buttons
            document.querySelectorAll('.view-toggle button').forEach(btn => {
                if (btn.textContent === 'Passages') {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
            // Reset to passages list view
            document.getElementById('passagesListSection').style.display = 'block';
            document.getElementById('passageDetailSection').style.display = 'none';
            // Load lessons, writing sections, and passages if not already loaded
            if (document.getElementById('lessonsList').innerHTML === '') {
                loadLessons();
            }
            if (document.getElementById('writingSectionsList').innerHTML === '') {
                loadWritingSections();
            }
            if (document.getElementById('passagesList').innerHTML === '') {
                loadPassages();
            }
        }
        
        async function checkAuth() {
            try {
                const response = await fetch(`${API_BASE}/auth/me`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                if (response.ok) {
                    currentUser = await response.json();
                    updateUI();
                    // Keep landing page visible - user can navigate to passages when ready
                } else {
                    localStorage.removeItem('authToken');
                    authToken = null;
                    loadPassages();
                }
            } catch (error) {
                console.error('Auth check failed:', error);
                loadPassages();
            }
        }
        
        async function handleLogin(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const data = {
                email: formData.get('email'),
                password: formData.get('password')
            };
            
            try {
                const response = await fetch(`${API_BASE}/auth/login`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    authToken = result.tokens.access;
                    localStorage.setItem('authToken', authToken);
                    currentUser = result.user;
                    closeModal('loginModal');
                    updateUI();
                    // Stay on landing page - user can navigate to passages when ready
                } else {
                    document.getElementById('loginError').textContent = result.error?.message || 'Login failed';
                }
            } catch (error) {
                document.getElementById('loginError').textContent = 'Network error. Please try again.';
            }
        }
        
        async function handleRegister(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const data = {
                email: formData.get('email'),
                password: formData.get('password')
            };
            
            try {
                const response = await fetch(`${API_BASE}/auth/register`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    authToken = result.tokens.access;
                    localStorage.setItem('authToken', authToken);
                    currentUser = result.user;
                    closeModal('registerModal');
                    updateUI();
                    
                    // If there's a saved attempt from before registration, save it now
                    if (lastAttemptData) {
                        const savedPassageId = lastAttemptData.passage_id;
                        await saveAnonymousAttempt(lastAttemptData);
                        lastAttemptData = null; // Clear after saving
                        
                        // Navigate to passages view
                        showPassages();
                        await loadPassages();
                        
                        // Show attempt history for the passage that was attempted
                        if (savedPassageId) {
                            setTimeout(() => {
                                showAttemptHistory(savedPassageId);
                            }, 500);
                        }
                    } else {
                        // Navigate to passages view
                        showPassages();
                        await loadPassages();
                    }
                } else {
                    document.getElementById('registerError').textContent = result.error?.message || 'Registration failed';
                }
            } catch (error) {
                document.getElementById('registerError').textContent = 'Network error. Please try again.';
            }
        }
        
        async function loadLessons() {
            try {
                const headers = {};
                if (authToken) {
                    headers['Authorization'] = `Bearer ${authToken}`;
                }
                
                const response = await fetch(`${API_BASE}/lessons/`, {headers});
                const data = await response.json();
                
                const lessonsList = document.getElementById('lessonsList');
                lessonsList.innerHTML = '';
                
                if (data.results && data.results.length > 0) {
                    data.results.forEach(lesson => {
                        const card = document.createElement('div');
                        card.className = `passage-card ${lesson.tier === 'premium' ? 'premium' : ''}`;
                        card.innerHTML = `
                            <h3>${lesson.title} ${lesson.tier === 'premium' ? '<span class="premium-badge">PREMIUM</span>' : ''}</h3>
                            <p>Difficulty: ${lesson.difficulty} | Questions: ${lesson.question_count || 0}</p>
                        `;
                        card.onclick = () => openLesson(lesson.id);
                        lessonsList.appendChild(card);
                    });
                } else {
                    lessonsList.innerHTML = '<p style="color: #666; font-style: italic;">No lessons available yet.</p>';
                }
            } catch (error) {
                console.error('Failed to load lessons:', error);
                const lessonsList = document.getElementById('lessonsList');
                lessonsList.innerHTML = '<p style="color: #999;">Unable to load lessons.</p>';
            }
        }
        
        async function loadWritingSections() {
            try {
                const headers = {};
                if (authToken) {
                    headers['Authorization'] = `Bearer ${authToken}`;
                }
                
                const response = await fetch(`${API_BASE}/writing-sections/`, {headers});
                const data = await response.json();
                
                const writingSectionsList = document.getElementById('writingSectionsList');
                writingSectionsList.innerHTML = '';
                
                if (data.results && data.results.length > 0) {
                    data.results.forEach(writingSection => {
                        const card = document.createElement('div');
                        card.className = `passage-card ${writingSection.tier === 'premium' ? 'premium' : ''}`;
                        const attemptCount = writingSection.attempt_count || 0;
                        const attemptText = attemptCount > 0 ? ` | ${attemptCount} attempt${attemptCount !== 1 ? 's' : ''}` : '';
                        
                        let attemptSummaryHTML = '';
                        if (writingSection.attempt_summary && attemptCount > 0) {
                            const summary = writingSection.attempt_summary;
                            attemptSummaryHTML = `
                                <div style="background: #f9f9f9; border: 1px solid #e0e0e0; border-radius: 6px; padding: 12px; margin-top: 10px; font-size: 13px;">
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                        <span style="color: #666;"><strong>Best Score:</strong></span>
                                        <span style="color: #3498DB; font-weight: bold;">${summary.best_score}%</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                        <span style="color: #666;"><strong>Latest Score:</strong></span>
                                        <span style="color: #000; font-weight: bold;">${summary.latest_score}%</span>
                                    </div>
                                    ${summary.recent_attempts && summary.recent_attempts.length > 0 ? `
                                        <div style="margin-top: 10px; padding-top: 8px; border-top: 1px solid #e0e0e0;">
                                            <div style="color: #666; margin-bottom: 6px; font-size: 12px;"><strong>Recent Attempts:</strong></div>
                                            ${summary.recent_attempts.map((attempt, idx) => {
                                                const date = new Date(attempt.completed_at);
                                                const dateStr = date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                                                return `
                                                    <div style="display: flex; justify-content: space-between; font-size: 11px; color: #666; margin-bottom: 4px;">
                                                        <span>${dateStr}</span>
                                                        <span style="font-weight: bold; color: #000;">${attempt.score}%</span>
                                                    </div>
                                                `;
                                            }).join('')}
                                        </div>
                                    ` : ''}
                                </div>
                            `;
                        }
                        
                        card.innerHTML = `
                            <h3>${writingSection.title} ${writingSection.tier === 'premium' ? '<span class="premium-badge">PREMIUM</span>' : ''}</h3>
                            <p>Difficulty: ${writingSection.difficulty} | Questions: ${writingSection.question_count || 0} | Selections: ${writingSection.selection_count || 0}${attemptText}</p>
                            ${attemptSummaryHTML}
                            ${attemptCount > 0 && authToken ? `<button class="btn btn-secondary" onclick="event.stopPropagation(); showWritingSectionAttemptHistory('${writingSection.id}')" style="margin-top: 10px; font-size: 12px; padding: 6px 12px; width: 100%;">View Full Attempt History</button>` : ''}
                        `;
                        card.onclick = () => openWritingSection(writingSection.id);
                        writingSectionsList.appendChild(card);
                    });
                } else {
                    writingSectionsList.innerHTML = '<p style="color: #666; font-style: italic;">No writing sections available yet.</p>';
                }
            } catch (error) {
                console.error('Failed to load writing sections:', error);
                const writingSectionsList = document.getElementById('writingSectionsList');
                writingSectionsList.innerHTML = '<p style="color: #999;">Unable to load writing sections.</p>';
            }
        }
        
        async function loadPassages() {
            try {
                const headers = {};
                if (authToken) {
                    headers['Authorization'] = `Bearer ${authToken}`;
                }
                
                const response = await fetch(`${API_BASE}/passages/`, {headers});
                const data = await response.json();
                
                const passagesList = document.getElementById('passagesList');
                passagesList.innerHTML = '';
                
                if (data.results && data.results.length > 0) {
                    data.results.forEach(passage => {
                        const card = document.createElement('div');
                        card.className = `passage-card ${passage.tier === 'premium' ? 'premium' : ''}`;
                        const attemptCount = passage.attempt_count || 0;
                        const attemptText = attemptCount > 0 ? ` | ${attemptCount} attempt${attemptCount !== 1 ? 's' : ''}` : '';
                        
                        let attemptSummaryHTML = '';
                        if (passage.attempt_summary && attemptCount > 0) {
                            const summary = passage.attempt_summary;
                            attemptSummaryHTML = `
                                <div style="background: #f9f9f9; border: 1px solid #e0e0e0; border-radius: 6px; padding: 12px; margin-top: 10px; font-size: 13px;">
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                        <span style="color: #666;"><strong>Best Score:</strong></span>
                                        <span style="color: #3498DB; font-weight: bold;">${summary.best_score}%</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                        <span style="color: #666;"><strong>Latest Score:</strong></span>
                                        <span style="color: #000; font-weight: bold;">${summary.latest_score}%</span>
                                    </div>
                                    ${summary.recent_attempts && summary.recent_attempts.length > 0 ? `
                                        <div style="margin-top: 10px; padding-top: 8px; border-top: 1px solid #e0e0e0;">
                                            <div style="color: #666; margin-bottom: 6px; font-size: 12px;"><strong>Recent Attempts:</strong></div>
                                            ${summary.recent_attempts.map((attempt, idx) => {
                                                const date = new Date(attempt.completed_at);
                                                const dateStr = date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                                                return `
                                                    <div style="display: flex; justify-content: space-between; font-size: 11px; color: #666; margin-bottom: 4px;">
                                                        <span>${dateStr}</span>
                                                        <span style="font-weight: bold; color: #000;">${attempt.score}%</span>
                                                    </div>
                                                `;
                                            }).join('')}
                                        </div>
                                    ` : ''}
                                </div>
                            `;
                        }
                        
                        card.innerHTML = `
                            <h3>${passage.title} ${passage.tier === 'premium' ? '<span class="premium-badge">PREMIUM</span>' : ''}</h3>
                            <p>Difficulty: ${passage.difficulty} | Questions: ${passage.question_count}${attemptText}</p>
                            ${attemptSummaryHTML}
                            ${attemptCount > 0 && authToken ? `<button class="btn btn-secondary" onclick="event.stopPropagation(); showAttemptHistory('${passage.id}')" style="margin-top: 10px; font-size: 12px; padding: 6px 12px; width: 100%;">View Full Attempt History</button>` : ''}
                        `;
                        card.onclick = () => openPassage(passage.id);
                        passagesList.appendChild(card);
                    });
                } else {
                    passagesList.innerHTML = '<p>No passages available.</p>';
                }
            } catch (error) {
                console.error('Failed to load passages:', error);
            }
        }
        
        let currentPassageId = null;
        let currentPassageData = null;
        let currentLessonId = null;
        let currentLessonData = null;
        let currentWritingSectionId = null;
        let currentWritingSectionData = null;
        let userAnswers = {};
        
        async function openLesson(lessonId) {
            try {
                currentLessonId = lessonId;
                currentPassageId = null; // Clear passage data
                currentPassageData = null;
                userAnswers = {};
                
                const headers = {};
                if (authToken) {
                    headers['Authorization'] = `Bearer ${authToken}`;
                }
                
                // Fetch lesson detail
                const lessonResponse = await fetch(`${API_BASE}/lessons/${lessonId}`, {headers});
                if (lessonResponse.status === 403) {
                    alert('This lesson requires a premium subscription. Please upgrade to access premium content.');
                    return;
                }
                
                if (!lessonResponse.ok) {
                    alert('Failed to load lesson. Please try again.');
                    return;
                }
                
                const lessonData = await lessonResponse.json();
                currentLessonData = lessonData;
                
                // Display lesson
                displayLesson(lessonData);
                
            } catch (error) {
                console.error('Failed to open lesson:', error);
                alert('Network error. Please try again.');
            }
        }
        
        function displayLesson(lesson) {
            // Hide all list sections, show detail view
            document.getElementById('passagesListSection').style.display = 'none';
            document.getElementById('lessonsListSection').style.display = 'none';
            document.getElementById('writingSectionsListSection').style.display = 'none';
            document.getElementById('passageDetailSection').style.display = 'block';
            
            // Clear attempt history button
            document.getElementById('attemptHistoryButtonContainer').innerHTML = '';
            
            // Render lesson content from chunks
            let contentHTML = `<h2 style="color: #3498DB; margin-bottom: 15px;">${escapeHtml(lesson.title)}</h2>`;
            contentHTML += '<div class="lesson-content" style="max-width: 800px; margin: 0 auto;">';
            
            lesson.chunks.forEach((chunk, chunkIdx) => {
                const chunkType = chunk.type;
                
                if (chunkType === 'header') {
                    const level = chunk.level || 1;
                    const text = chunk.text || '';
                    const tag = `h${Math.min(level + 1, 6)}`;
                    contentHTML += `<${tag} style="color: #3498DB; margin-top: 20px; margin-bottom: 10px;">${escapeHtml(text)}</${tag}>`;
                } else if (chunkType === 'paragraph') {
                    contentHTML += `<p style="margin-bottom: 15px; line-height: 1.6; color: #000;">${escapeHtml(chunk.text || '')}</p>`;
                } else if (chunkType === 'example') {
                    contentHTML += `<div style="background: #f0f8ff; border-left: 4px solid #3498DB; padding: 10px 15px; margin: 15px 0; font-style: italic; color: #000;">${escapeHtml(chunk.text || '')}</div>`;
                } else if (chunkType === 'example_correct') {
                    contentHTML += `<div style="background: #f0fff0; border-left: 4px solid #28a745; padding: 10px 15px; margin: 15px 0; font-style: italic; color: #000;">‚úì ${escapeHtml(chunk.text || '')}</div>`;
                } else if (chunkType === 'example_incorrect') {
                    contentHTML += `<div style="background: #fff0f0; border-left: 4px solid #dc3545; padding: 10px 15px; margin: 15px 0; font-style: italic; color: #000;">‚úó ${escapeHtml(chunk.text || '')}</div>`;
                } else if (chunkType === 'rule') {
                    contentHTML += `<div style="background: #fff9e6; border-left: 4px solid #ffc107; padding: 10px 15px; margin: 15px 0; font-weight: bold; color: #000;">Rule: ${escapeHtml(chunk.text || '')}</div>`;
                } else if (chunkType === 'definition') {
                    contentHTML += `<div style="margin: 15px 0;"><strong style="color: #3498DB;">${escapeHtml(chunk.term || '')}:</strong> <span style="color: #000;">${escapeHtml(chunk.text || '')}</span></div>`;
                } else if (chunkType === 'list' || chunkType === 'bullet_list') {
                    const items = chunk.items || [];
                    const listType = chunkType === 'bullet_list' ? 'ul' : 'ol';
                    contentHTML += `<${listType} style="margin: 15px 0; padding-left: 30px; color: #000;">`;
                    items.forEach(item => {
                        contentHTML += `<li style="margin-bottom: 8px;">${escapeHtml(item)}</li>`;
                    });
                    contentHTML += `</${listType}>`;
                } else if (chunkType === 'question') {
                    // Render question directly from chunk (questions are embedded in chunks)
                    contentHTML += `<div class="question-card" style="margin: 20px 0; padding: 15px; border: 2px solid #3498DB; border-radius: 8px; background: #f9f9f9;">`;
                    contentHTML += `<h4 style="color: #000; margin-bottom: 10px;">${escapeHtml(chunk.prompt || '')}</h4>`;
                    contentHTML += `<div class="options-container">`;
                    (chunk.choices || []).forEach((choice, idx) => {
                        contentHTML += `
                            <div class="option" style="margin-bottom: 8px;">
                                <label style="color: #000; cursor: pointer; display: block; padding: 8px; border-radius: 4px; transition: background 0.2s;" onmouseover="this.style.background='#f0f0f0'" onmouseout="this.style.background='transparent'">${String.fromCharCode(65 + idx)}. ${escapeHtml(choice)}</label>
                            </div>
                        `;
                    });
                    contentHTML += `</div>`;
                    contentHTML += `</div>`;
                } else if (chunkType === 'note') {
                    contentHTML += `<div style="background: #e3f2fd; border-left: 4px solid #2196F3; padding: 10px 15px; margin: 15px 0; color: #000;">üìù Note: ${escapeHtml(chunk.text || '')}</div>`;
                } else if (chunkType === 'warning') {
                    contentHTML += `<div style="background: #fff3cd; border-left: 4px solid #ffc107; padding: 10px 15px; margin: 15px 0; color: #000;">‚ö†Ô∏è Warning: ${escapeHtml(chunk.text || '')}</div>`;
                } else if (chunkType === 'summary') {
                    contentHTML += `<div style="background: #f0f0f0; border: 2px solid #666; padding: 15px; margin: 20px 0; border-radius: 8px; color: #000;"><strong>Summary:</strong> ${escapeHtml(chunk.text || '')}</div>`;
                }
            });
            
            contentHTML += '</div>';
            
            document.getElementById('passageContent').innerHTML = contentHTML;
            
            // Hide questions container and submit section for lessons (questions are inline)
            document.getElementById('questionsContainer').innerHTML = '';
            document.getElementById('submitSection').style.display = 'none';
            document.getElementById('resultsSection').style.display = 'none';
        }
        
        async function openPassage(passageId) {
            try {
                currentPassageId = passageId;
                userAnswers = {};
                
                const headers = {};
                if (authToken) {
                    headers['Authorization'] = `Bearer ${authToken}`;
                }
                
                // Fetch passage detail with content
                const passageResponse = await fetch(`${API_BASE}/passages/${passageId}`, {headers});
                if (passageResponse.status === 403) {
                    alert('This passage requires a premium subscription. Please upgrade to access premium content.');
                    return;
                }
                
                if (!passageResponse.ok) {
                    alert('Failed to load passage. Please try again.');
                    return;
                }
                
                const passageData = await passageResponse.json();
                currentPassageData = passageData;
                
                // Fetch questions (without answers)
                const questionsResponse = await fetch(`${API_BASE}/passages/${passageId}/questions`, {headers});
                if (!questionsResponse.ok) {
                    alert('Failed to load questions. Please try again.');
                    return;
                }
                
                const questionsData = await questionsResponse.json();
                
                // Display passage
                displayPassage(passageData, questionsData);
                
            } catch (error) {
                console.error('Failed to open passage:', error);
                alert('Network error. Please try again.');
            }
        }
        
        function formatPassageForSAT(content) {
            // First, normalize content: convert literal \n strings to actual newlines
            if (typeof content === 'string') {
                // Handle literal \n strings (both \\n and \n)
                content = content.replace(/\\\\n/g, '\n');
                content = content.replace(/\\n/g, '\n');
            }
            
            // Split content into paragraphs (double newlines separate paragraphs)
            // Preserve original line breaks but wrap to 50 characters
            const allLines = [];
            const paragraphs = content.split(/\n\n+/);
            
            paragraphs.forEach((paragraph, paraIndex) => {
                // Split paragraph by single newlines to preserve line breaks
                const originalLines = paragraph.split(/\n/);
                
                originalLines.forEach(originalLine => {
                    const trimmed = originalLine.trim();
                    
                    if (!trimmed) {
                        // Empty line - preserve it as blank line
                        allLines.push('');
                        return;
                    }
                    
                    // Wrap this line to 50 characters
                    const words = trimmed.split(/\s+/);
                    let currentLine = '';
                    
                    words.forEach(word => {
                        const testLine = currentLine ? currentLine + ' ' + word : word;
                        if (testLine.length <= 50) {
                            currentLine = testLine;
                        } else {
                            // Save current line and start new one
                            if (currentLine) {
                                allLines.push(currentLine);
                            }
                            // If word itself is longer than 50 chars, split it
                            if (word.length > 50) {
                                let remaining = word;
                                while (remaining.length > 50) {
                                    allLines.push(remaining.substring(0, 50));
                                    remaining = remaining.substring(50);
                                }
                                currentLine = remaining;
                            } else {
                                currentLine = word;
                            }
                        }
                    });
                    
                    // Add remaining line
                    if (currentLine) {
                        allLines.push(currentLine);
                    }
                });
                
                // Add blank line between paragraphs (but not after last paragraph)
                if (paraIndex < paragraphs.length - 1) {
                    allLines.push('');
                }
            });
            
            // Calculate line numbers: skip blank lines in numbering
            let lineNumber = 0; // This counts only non-blank lines
            const linesWithNumbers = allLines.map(line => {
                const isBlank = !line || line.trim() === '';
                if (!isBlank) {
                    lineNumber++;
                }
                return {
                    text: line,
                    isBlank: isBlank,
                    lineNumber: isBlank ? null : lineNumber
                };
            });
            
            // Format lines with line numbers every 5 lines (5, 10, 15, 20, etc.)
            // But only show numbers on non-blank lines
            let formattedHTML = '<div class="passage-columns">';
            const linesPerColumn = Math.ceil(linesWithNumbers.length / 2);
            
            // Create two columns
            for (let col = 0; col < 2; col++) {
                formattedHTML += '<div class="passage-column">';
                const startLine = col * linesPerColumn;
                const endLine = Math.min(startLine + linesPerColumn, linesWithNumbers.length);
                
                for (let i = startLine; i < endLine; i++) {
                    const lineData = linesWithNumbers[i];
                    const line = lineData.text;
                    const lineNum = lineData.lineNumber;
                    
                    // Show line number every 5 lines (5, 10, 15, 20, etc.) but only on non-blank lines
                    const shouldShowNumber = lineNum !== null && lineNum % 5 === 0;
                    
                    if (shouldShowNumber) {
                        formattedHTML += `<div class="passage-line-numbered">`;
                        formattedHTML += `<span class="line-number">${lineNum}</span>`;
                        formattedHTML += `<span class="line-text">${escapeHtml(line || ' ')}</span>`;
                        formattedHTML += `</div>`;
                    } else {
                        // Still use numbered format for alignment, but with empty number
                        formattedHTML += `<div class="passage-line-numbered">`;
                        formattedHTML += `<span class="line-number"></span>`;
                        formattedHTML += `<span class="line-text">${escapeHtml(line || ' ')}</span>`;
                        formattedHTML += `</div>`;
                    }
                }
                
                formattedHTML += '</div>';
            }
            
            formattedHTML += '</div>';
            return formattedHTML;
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        function formatWritingSectionContent(content, selections) {
            // First, normalize the content - remove all line breaks and normalize whitespace
            // Convert literal \n strings to actual newlines if needed
            if (typeof content === 'string') {
                content = content.replace(/\\\\n/g, '\n');
                content = content.replace(/\\n/g, '\n');
            }
            
            // Store original for position calculations
            const originalContent = content;
            
            // Normalize whitespace: convert all line breaks to spaces, collapse multiple spaces
            // But we need to map positions from original to normalized
            let normalizedContent = originalContent.replace(/\r\n/g, ' '); // Windows line breaks
            normalizedContent = normalizedContent.replace(/\n/g, ' '); // Unix line breaks
            normalizedContent = normalizedContent.replace(/\r/g, ' '); // Old Mac line breaks
            normalizedContent = normalizedContent.replace(/\s+/g, ' '); // Collapse multiple spaces/tabs/etc to single space
            normalizedContent = normalizedContent.trim();
            
            // Build a mapping from original positions to normalized positions
            // This is complex, so instead let's rebuild selections based on normalized content
            const sortedSelections = [...selections].sort((a, b) => a.start_char - b.start_char);
            
            // Recalculate selection positions in normalized content
            const normalizedSelections = sortedSelections.map(sel => {
                const selectedText = originalContent.substring(sel.start_char, sel.end_char).trim();
                // Find this text in the normalized content
                const pos = normalizedContent.indexOf(selectedText);
                if (pos !== -1) {
                    return {
                        ...sel,
                        start_char: pos,
                        end_char: pos + selectedText.length,
                        selected_text: selectedText
                    };
                }
                // Try case-insensitive
                const normalizedLower = normalizedContent.toLowerCase();
                const selectedLower = selectedText.toLowerCase();
                const posLower = normalizedLower.indexOf(selectedLower);
                if (posLower !== -1) {
                    const actualText = normalizedContent.substring(posLower, posLower + selectedText.length);
                    return {
                        ...sel,
                        start_char: posLower,
                        end_char: posLower + actualText.length,
                        selected_text: actualText
                    };
                }
                return sel; // Keep original if can't find
            });
            
            // Now use normalized content and adjusted selections
            content = normalizedContent;
            
            // Build the formatted content with selections
            let formattedHTML = '<div class="passage-content-sat" style="line-height: 1.8; font-size: 16px; max-width: 800px;">';
            let lastIndex = 0;
            let htmlParts = [];
            
            // Process each selection and insert underlined text
            normalizedSelections.forEach(selection => {
                // Add text before selection
                if (selection.start_char > lastIndex) {
                    const beforeText = content.substring(lastIndex, selection.start_char);
                    htmlParts.push(escapeHtml(beforeText));
                }
                
                // Add underlined selection with number
                const selectedText = content.substring(selection.start_char, selection.end_char);
                htmlParts.push(`<span style="text-decoration: underline; font-weight: 500; color: #000; background-color: #fffacd; padding: 2px 4px;">
                    [${selection.number}] <u>${escapeHtml(selectedText)}</u>
                </span>`);
                
                lastIndex = selection.end_char;
            });
            
            // Add remaining text after last selection
            if (lastIndex < content.length) {
                const afterText = content.substring(lastIndex);
                htmlParts.push(escapeHtml(afterText));
            }
            
            // Combine all parts
            let fullText = htmlParts.join('');
            
            // Wrap in paragraph tags for natural text flow
            formattedHTML += '<p style="margin-bottom: 12px; text-align: left; white-space: normal;">' + fullText + '</p>';
            
            formattedHTML += '</div>';
            return formattedHTML;
        }
        
        async function openWritingSection(writingSectionId) {
            try {
                currentWritingSectionId = writingSectionId;
                currentPassageId = null; // Clear passage data
                currentPassageData = null;
                currentLessonId = null;
                currentLessonData = null;
                userAnswers = {};
                
                const headers = {};
                if (authToken) {
                    headers['Authorization'] = `Bearer ${authToken}`;
                }
                
                // Fetch writing section detail
                const sectionResponse = await fetch(`${API_BASE}/writing-sections/${writingSectionId}`, {headers});
                if (sectionResponse.status === 403) {
                    alert('This writing section requires a premium subscription. Please upgrade to access premium content.');
                    return;
                }
                
                if (!sectionResponse.ok) {
                    alert('Failed to load writing section. Please try again.');
                    return;
                }
                
                const sectionData = await sectionResponse.json();
                currentWritingSectionData = sectionData;
                
                // Fetch questions (without answers)
                const questionsResponse = await fetch(`${API_BASE}/writing-sections/${writingSectionId}/questions`, {headers});
                if (!questionsResponse.ok) {
                    alert('Failed to load questions. Please try again.');
                    return;
                }
                
                const questionsData = await questionsResponse.json();
                
                // Display writing section
                displayWritingSection(sectionData, questionsData);
                
            } catch (error) {
                console.error('Failed to open writing section:', error);
                alert('Network error. Please try again.');
            }
        }
        
        function displayWritingSection(writingSection, questions) {
            // Hide all list sections, show detail view
            document.getElementById('passagesListSection').style.display = 'none';
            document.getElementById('lessonsListSection').style.display = 'none';
            document.getElementById('writingSectionsListSection').style.display = 'none';
            document.getElementById('passageDetailSection').style.display = 'block';
            
            // Show attempt history button if user is logged in
            const attemptHistoryContainer = document.getElementById('attemptHistoryButtonContainer');
            if (authToken && writingSection.id) {
                try {
                    const attemptsResponse = await fetch(`${API_BASE}/progress/writing-sections/${writingSection.id}/attempts`, {
                        headers: {'Authorization': `Bearer ${authToken}`}
                    });
                    if (attemptsResponse.ok) {
                        const attempts = await attemptsResponse.json();
                        if (attempts.length > 0) {
                            attemptHistoryContainer.innerHTML = `
                                <button class="btn btn-secondary" onclick="showWritingSectionAttemptHistory('${writingSection.id}')" style="font-size: 12px; padding: 6px 12px;">
                                    üìä View Attempt History (${attempts.length})
                                </button>
                            `;
                        } else {
                            attemptHistoryContainer.innerHTML = '';
                        }
                    } else {
                        attemptHistoryContainer.innerHTML = '';
                    }
                } catch (error) {
                    console.error('Failed to load attempt history:', error);
                    attemptHistoryContainer.innerHTML = '';
                }
            } else {
                attemptHistoryContainer.innerHTML = '';
            }
            
            // Format content with underlined selections
            const formattedContent = formatWritingSectionContent(writingSection.content, writingSection.selections || []);
            
            document.getElementById('passageContent').innerHTML = `
                <h2 style="color: #3498DB; margin-bottom: 15px;">${escapeHtml(writingSection.title)}</h2>
                ${formattedContent}
            `;
            
            // Display questions in two columns (similar to passages)
            const questionsContainer = document.getElementById('questionsContainer');
            questionsContainer.innerHTML = '<div class="questions-columns"><div class="question-column-left"></div><div class="question-column-right"></div></div>';
            
            const leftColumn = questionsContainer.querySelector('.question-column-left');
            const rightColumn = questionsContainer.querySelector('.question-column-right');
            
            (questions.questions || []).forEach((question, index) => {
                const questionNumber = question.order !== undefined ? question.order : (index + 1);
                const questionCard = document.createElement('div');
                questionCard.className = 'question-card';
                
                // Show selection number if question is linked to a selection
                let selectionInfo = '';
                if (question.selection_number) {
                    selectionInfo = `<p style="color: #666; font-size: 13px; margin-bottom: 8px;">Refer to selection [${question.selection_number}]</p>`;
                }
                
                questionCard.innerHTML = `
                    <h4>Question ${questionNumber}</h4>
                    ${selectionInfo}
                    <p style="margin-bottom: 15px; font-size: 16px; color: #000;">${escapeHtml(question.text)}</p>
                    <div class="options-container">
                        ${question.options && question.options.length > 0 ? question.options.map((option, optIndex) => `
                            <div class="option" onclick="selectOption('${question.id}', ${optIndex})">
                                <input type="radio" name="question_${question.id}" value="${optIndex}" id="opt_${question.id}_${optIndex}">
                                <label class="option-label" for="opt_${question.id}_${optIndex}">
                                    ${String.fromCharCode(65 + optIndex)}. ${escapeHtml(option.text || option)}
                                </label>
                            </div>
                        `).join('') : '<p style="color: red;">No options available for this question</p>'}
                    </div>
                `;
                
                // Alternate between left and right columns
                if (index % 2 === 0) {
                    leftColumn.appendChild(questionCard);
                } else {
                    rightColumn.appendChild(questionCard);
                }
            });
            
            // For now, hide submit section for writing sections (no backend endpoint yet)
            // Show submit section
            document.getElementById('submitSection').style.display = 'block';
            document.getElementById('resultsSection').style.display = 'none';
        }
        
        async function displayPassage(passage, questions) {
            // Hide passages list, lessons list, and writing sections list, show passage detail
            document.getElementById('passagesListSection').style.display = 'none';
            document.getElementById('lessonsListSection').style.display = 'none';
            document.getElementById('writingSectionsListSection').style.display = 'none';
            document.getElementById('passageDetailSection').style.display = 'block';
            
            // Show attempt history button if user is logged in
            const attemptHistoryContainer = document.getElementById('attemptHistoryButtonContainer');
            if (authToken && passage.id) {
                try {
                    const attemptsResponse = await fetch(`${API_BASE}/progress/passages/${passage.id}/attempts`, {
                        headers: {'Authorization': `Bearer ${authToken}`}
                    });
                    if (attemptsResponse.ok) {
                        const attempts = await attemptsResponse.json();
                        if (attempts.length > 0) {
                            attemptHistoryContainer.innerHTML = `
                                <button class="btn btn-secondary" onclick="showAttemptHistory('${passage.id}')" style="font-size: 12px; padding: 6px 12px;">
                                    üìä View Attempt History (${attempts.length})
                                </button>
                            `;
                        } else {
                            attemptHistoryContainer.innerHTML = '';
                        }
                    } else {
                        attemptHistoryContainer.innerHTML = '';
                    }
                } catch (error) {
                    console.error('Failed to load attempt count:', error);
                    attemptHistoryContainer.innerHTML = '';
                }
            } else {
                attemptHistoryContainer.innerHTML = '';
            }
            
            // Format passage in SAT style (50 chars per line, two columns, line numbers every 5)
            const formattedContent = formatPassageForSAT(passage.content);
            
            document.getElementById('passageContent').innerHTML = `
                <h2 style="color: #3498DB; margin-bottom: 15px;">${passage.title}</h2>
                <div class="passage-content-sat">${formattedContent}</div>
            `;
            
            // Display questions in two columns
            const questionsContainer = document.getElementById('questionsContainer');
            questionsContainer.innerHTML = '<div class="questions-columns"><div class="question-column-left"></div><div class="question-column-right"></div></div>';
            
            const leftColumn = questionsContainer.querySelector('.question-column-left');
            const rightColumn = questionsContainer.querySelector('.question-column-right');
            
            // Debug: log questions to see what we're getting
            console.log('Questions received:', questions.questions);
            
            questions.questions.forEach((question, index) => {
                // Use question.order if available, otherwise use index + 1
                const questionNumber = question.order !== undefined ? question.order : (index + 1);
                const questionCard = document.createElement('div');
                questionCard.className = 'question-card';
                questionCard.innerHTML = `
                    <h4>Question ${questionNumber}</h4>
                    <p style="margin-bottom: 15px; font-size: 16px; color: #000;">${question.text}</p>
                    <div class="options-container">
                        ${question.options && question.options.length > 0 ? question.options.map((option, optIndex) => `
                            <div class="option" onclick="selectOption('${question.id}', ${optIndex})">
                                <input type="radio" name="question_${question.id}" value="${optIndex}" id="opt_${question.id}_${optIndex}">
                                <label class="option-label" for="opt_${question.id}_${optIndex}">
                                    ${String.fromCharCode(65 + optIndex)}. ${option}
                                </label>
                            </div>
                        `).join('') : '<p style="color: red;">No options available for this question</p>'}
                    </div>
                `;
                
                // Alternate between left and right columns
                if (index % 2 === 0) {
                    leftColumn.appendChild(questionCard);
                } else {
                    rightColumn.appendChild(questionCard);
                }
            });
            
            // Show submit button, hide results
            document.getElementById('submitSection').style.display = 'block';
            document.getElementById('resultsSection').style.display = 'none';
        }
        
        function selectOption(questionId, optionIndex) {
            userAnswers[questionId] = optionIndex;
            
            // Update visual selection
            const questionCard = document.querySelector(`input[name="question_${questionId}"]`).closest('.question-card');
            questionCard.querySelectorAll('.option').forEach(opt => opt.classList.remove('selected'));
            questionCard.querySelector(`#opt_${questionId}_${optionIndex}`).closest('.option').classList.add('selected');
            questionCard.querySelector(`#opt_${questionId}_${optionIndex}`).checked = true;
        }
        
        async function submitAnswers() {
            // Check if we're on a passage or writing section
            if (!currentPassageId && !currentWritingSectionId) return;
            
            // Determine if we're on a passage or writing section
            const isWritingSection = !!currentWritingSectionId;
            const currentId = isWritingSection ? currentWritingSectionId : currentPassageId;
            const currentData = isWritingSection ? currentWritingSectionData : currentPassageData;
            
            if (!currentId || !currentData) return;
            
            // Check if all questions are answered
            const totalQuestions = currentData.questions.length;
            if (Object.keys(userAnswers).length < totalQuestions) {
                if (!confirm(`You have only answered ${Object.keys(userAnswers).length} out of ${totalQuestions} questions. Submit anyway?`)) {
                    return;
                }
            }
            
            try {
                const headers = {
                    'Content-Type': 'application/json'
                };
                if (authToken) {
                    headers['Authorization'] = `Bearer ${authToken}`;
                }
                
                // Convert answers to API format
                const answers = Object.entries(userAnswers).map(([questionId, selectedIndex]) => ({
                    question_id: questionId,
                    selected_option_index: selectedIndex
                }));
                
                // Submit answers - use appropriate endpoint
                const submitEndpoint = isWritingSection
                    ? `${API_BASE}/progress/writing-sections/${currentId}/submit`
                    : `${API_BASE}/progress/passages/${currentId}/submit`;
                
                const submitResponse = await fetch(submitEndpoint, {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify({
                        answers: answers,
                        time_spent_seconds: 0 // Could track this if needed
                    })
                });
                
                if (!submitResponse.ok) {
                    const error = await submitResponse.json();
                    alert(error.error?.message || 'Failed to submit answers. Please try again.');
                    return;
                }
                
                // Get submit response data (includes correct_count and total_questions)
                const submitData = await submitResponse.json();
                
                // Get review data for detailed answer breakdown
                const reviewEndpoint = isWritingSection
                    ? `${API_BASE}/progress/writing-sections/${currentId}/review`
                    : `${API_BASE}/progress/passages/${currentId}/review`;
                
                const reviewResponse = await fetch(reviewEndpoint, {
                    headers: authToken ? {'Authorization': `Bearer ${authToken}`} : {}
                });
                
                if (reviewResponse.ok) {
                    const reviewData = await reviewResponse.json();
                    // Use correct_count and total_questions from submit response (more reliable)
                    reviewData.correct_count = submitData.correct_count || reviewData.correct_count || 0;
                    reviewData.total_questions = submitData.total_questions || reviewData.total_questions || currentData.questions.length;
                    displayResults(reviewData, isWritingSection);
                } else {
                    // Fallback: use submit response data directly
                    if (submitData.correct_count !== undefined && submitData.total_questions !== undefined) {
                        displayResults({
                            correct_count: submitData.correct_count,
                            total_questions: submitData.total_questions,
                            answers: submitData.answers || []
                        }, isWritingSection);
                    } else {
                        // Final fallback: show results from data
                        if (isWritingSection) {
                            displayResultsFromWritingSection(currentData);
                        } else {
                            displayResultsFromPassage(currentData);
                        }
                    }
                }
                
            } catch (error) {
                console.error('Failed to submit answers:', error);
                alert('Network error. Please try again.');
            }
        }
        
        let lastAttemptData = null; // Store attempt data for anonymous users to save on registration
        
        function displayResults(reviewData, isWritingSection = false) {
            const resultsSection = document.getElementById('resultsSection');
            resultsSection.style.display = 'block';
            document.getElementById('submitSection').style.display = 'none';
            
            const currentId = isWritingSection ? currentWritingSectionId : currentPassageId;
            const currentData = isWritingSection ? currentWritingSectionData : currentPassageData;
            
            const correctCount = reviewData.correct_count || 0;
            const totalQuestions = reviewData.total_questions || (currentData ? currentData.questions.length : 0);
            const percentage = Math.round((correctCount / totalQuestions) * 100);
            
            // Store attempt data for anonymous users (to save on registration)
            if (!authToken && reviewData.attempt_id) {
                lastAttemptData = {
                    [isWritingSection ? 'writing_section_id' : 'passage_id']: currentId,
                    attempt_id: reviewData.attempt_id,
                    answers: reviewData.answers || [],
                    score: reviewData.score,
                    correct_count: correctCount,
                    total_questions: totalQuestions,
                    is_writing_section: isWritingSection
                };
            }
            
            let resultsHTML = `
                <div class="results-summary">
                    <h3>Your Results</h3>
                    <div class="score">${correctCount} / ${totalQuestions} (${percentage}%)</div>
                </div>
            `;
            
            // Show attempt history button for logged-in users
            if (authToken && currentId) {
                if (isWritingSection) {
                    resultsHTML += `
                        <div style="margin: 20px 0; text-align: center;">
                            <button class="btn btn-secondary" onclick="setTimeout(() => showWritingSectionAttemptHistory('${currentId}'), 500)" style="font-size: 14px; padding: 10px 20px;">
                                üìä View All Attempts for This Writing Section
                            </button>
                        </div>
                    `;
                } else {
                    resultsHTML += `
                        <div style="margin: 20px 0; text-align: center;">
                            <button class="btn btn-secondary" onclick="setTimeout(() => showAttemptHistory('${currentId}'), 500)" style="font-size: 14px; padding: 10px 20px;">
                                üìä View All Attempts for This Passage
                            </button>
                        </div>
                    `;
                }
            }
            
            // Show registration prompt for anonymous users
            if (!authToken) {
                resultsHTML += `
                    <div style="background: #e3f2fd; border: 2px solid #3498DB; border-radius: 8px; padding: 20px; margin: 20px 0; text-align: center;">
                        <h4 style="color: #3498DB; margin-bottom: 10px;">üí° Want to track your progress?</h4>
                        <p style="color: #333; margin-bottom: 15px;">Register now to save this attempt and track your improvement over time!</p>
                        <button class="btn btn-primary" onclick="showRegisterModalAndSaveAttempt()" style="font-size: 16px; padding: 12px 24px;">
                            Register & Save This Attempt
                        </button>
                        <p style="color: #666; font-size: 12px; margin-top: 10px;">Free to register ‚Ä¢ No credit card required</p>
                    </div>
                `;
            }
            
            // Show each question with correct/incorrect status
            const questions = currentData ? currentData.questions : [];
            questions.forEach((question, index) => {
                const userAnswer = userAnswers[question.id];
                const reviewAnswer = reviewData.answers && reviewData.answers.find(a => a.question_id === question.id);
                const isCorrect = reviewAnswer ? reviewAnswer.is_correct : (userAnswer === question.correct_answer_index);
                
                // Get options - handle both array of strings and array of objects
                const options = question.options || [];
                const userOption = options[userAnswer];
                const correctOption = options[question.correct_answer_index];
                
                // Use question.order if available, otherwise use index + 1
                const questionNumber = question.order !== undefined ? question.order : (index + 1);
                
                resultsHTML += `
                    <div class="question-card">
                        <h4>Question ${questionNumber} ${isCorrect ? '‚úì' : '‚úó'}</h4>
                        <p style="margin-bottom: 15px; font-size: 16px; color: #000;">${question.text}</p>
                        <div class="options-container">
                            ${options.map((option, optIndex) => {
                                let optionClass = 'option';
                                if (optIndex === question.correct_answer_index) {
                                    optionClass += ' correct';
                                } else if (optIndex === userAnswer && !isCorrect) {
                                    optionClass += ' incorrect';
                                }
                                
                                // Handle both object format (from passage detail) and string format (from questions endpoint)
                                const optionText = typeof option === 'string' ? option : option.text;
                                
                                return `
                                    <div class="${optionClass}">
                                        <input type="radio" disabled ${optIndex === userAnswer ? 'checked' : ''}>
                                        <label class="option-label">
                                            ${String.fromCharCode(65 + optIndex)}. ${optionText}
                                            ${optIndex === question.correct_answer_index ? ' (Correct)' : ''}
                                            ${optIndex === userAnswer && !isCorrect ? ' (Your Answer)' : ''}
                                        </label>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                        ${(reviewAnswer && reviewAnswer.explanation) || question.explanation ? `
                            <div class="explanation">
                                <strong>Explanation:</strong> ${(reviewAnswer && reviewAnswer.explanation) || question.explanation || ''}
                            </div>
                        ` : ''}
                    </div>
                `;
            });
            
            resultsSection.innerHTML = resultsHTML;
            
            // Scroll to results
            resultsSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
        
        function displayResultsFromPassage(passageData) {
            // Fallback if review endpoint fails - use passage data directly
            const resultsSection = document.getElementById('resultsSection');
            resultsSection.style.display = 'block';
            document.getElementById('submitSection').style.display = 'none';
            
            let correctCount = 0;
            passageData.questions.forEach(q => {
                if (userAnswers[q.id] === q.correct_answer_index) {
                    correctCount++;
                }
            });
            
            const totalQuestions = passageData.questions.length;
            const percentage = Math.round((correctCount / totalQuestions) * 100);
            
            let resultsHTML = `
                <div class="results-summary">
                    <h3>Your Results</h3>
                    <div class="score">${correctCount} / ${totalQuestions} (${percentage}%)</div>
                </div>
            `;
            
            passageData.questions.forEach((question, index) => {
                const userAnswer = userAnswers[question.id];
                const isCorrect = userAnswer === question.correct_answer_index;
                
                // Use question.order if available, otherwise use index + 1
                const questionNumber = question.order !== undefined ? question.order : (index + 1);
                
                resultsHTML += `
                    <div class="question-card">
                        <h4>Question ${questionNumber} ${isCorrect ? '‚úì' : '‚úó'}</h4>
                        <p style="margin-bottom: 15px; font-size: 16px; color: #000;">${question.text}</p>
                        <div class="options-container">
                            ${question.options.map((option, optIndex) => {
                                let optionClass = 'option';
                                if (optIndex === question.correct_answer_index) {
                                    optionClass += ' correct';
                                } else if (optIndex === userAnswer && !isCorrect) {
                                    optionClass += ' incorrect';
                                }
                                
                                // Handle both object format (from passage detail) and string format (from questions endpoint)
                                const optionText = typeof option === 'string' ? option : option.text;
                                
                                return `
                                    <div class="${optionClass}">
                                        <input type="radio" disabled ${optIndex === userAnswer ? 'checked' : ''}>
                                        <label class="option-label">
                                            ${String.fromCharCode(65 + optIndex)}. ${optionText}
                                            ${optIndex === question.correct_answer_index ? ' (Correct)' : ''}
                                            ${optIndex === userAnswer && !isCorrect ? ' (Your Answer)' : ''}
                                        </label>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                        ${question.explanation ? `
                            <div class="explanation">
                                <strong>Explanation:</strong> ${question.explanation}
                            </div>
                        ` : ''}
                    </div>
                `;
            });
            
            resultsSection.innerHTML = resultsHTML;
            resultsSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
        
        function backToPassagesList() {
            document.getElementById('passagesListSection').style.display = 'block';
            document.getElementById('lessonsListSection').style.display = 'block';
            document.getElementById('writingSectionsListSection').style.display = 'block';
            document.getElementById('passageDetailSection').style.display = 'none';
            currentPassageId = null;
            currentPassageData = null;
            currentLessonId = null;
            currentLessonData = null;
            currentWritingSectionId = null;
            currentWritingSectionData = null;
            userAnswers = {};
            lastAttemptData = null;
        }
        
        function showRegisterModalAndSaveAttempt() {
            // Store that we should save the attempt after registration
            showRegisterModal();
        }
        
        async function saveAnonymousAttempt(attemptData) {
            // This will be called after user registers to save their anonymous attempt
            // For now, we'll just show a message - the attempt was already submitted
            // In the future, we could create a new attempt record with the user's ID
            console.log('Saving anonymous attempt after registration:', attemptData);
            // Note: The attempt was already created on the server, we just need to associate it with the user
            // This would require a backend endpoint to update the attempt's user field
            // For now, we'll just show a success message
            if (currentPassageId) {
                // Reload passages to show attempt count
                loadPassages();
            }
        }
        
        async function showAttemptHistory(passageId) {
            if (!authToken) {
                alert('Please log in to view your attempt history.');
                return;
            }
            
            try {
                const url = `${API_BASE}/progress/passages/${passageId}/attempts`;
                console.log('Fetching attempt history from:', url);
                
                const response = await fetch(url, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                console.log('Response status:', response.status);
                
                if (!response.ok) {
                    let errorMessage = 'Please try again.';
                    try {
                        const errorData = await response.json();
                        console.error('Error response:', errorData);
                        errorMessage = errorData.error?.message || errorMessage;
                    } catch (e) {
                        console.error('Failed to parse error response:', e);
                        errorMessage = `HTTP ${response.status}: ${response.statusText}`;
                    }
                    alert(`Failed to load attempt history. ${errorMessage}`);
                    return;
                }
                
                const attempts = await response.json();
                
                if (attempts.length === 0) {
                    alert('No attempts found for this passage. Try refreshing the page.');
                    return;
                }
                
                // Show attempts in a modal
                let attemptsHTML = '<div style="max-height: 70vh; overflow-y: auto;">';
                attemptsHTML += `<h3 style="margin-bottom: 20px; color: #3498DB;">Attempt History</h3>`;
                
                attempts.forEach((attempt, index) => {
                    const date = new Date(attempt.completed_at);
                    const dateStr = date.toLocaleString();
                    const percentage = Math.round((attempt.correct_count / attempt.total_questions) * 100);
                    
                    attemptsHTML += `
                        <div style="border: 1px solid #d0d0d0; border-radius: 8px; padding: 15px; margin-bottom: 15px; background: white;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                <strong style="color: #000;">Attempt #${attempts.length - index}</strong>
                                <span style="color: #666; font-size: 12px;">${dateStr}</span>
                            </div>
                            <div style="color: #000; margin-bottom: 8px;">
                                Score: <strong style="color: #3498DB;">${attempt.correct_count} / ${attempt.total_questions} (${percentage}%)</strong>
                            </div>
                            ${attempt.time_spent_seconds ? `<div style="color: #666; font-size: 12px;">Time: ${Math.floor(attempt.time_spent_seconds / 60)}m ${attempt.time_spent_seconds % 60}s</div>` : ''}
                            <button class="btn btn-secondary" onclick="viewAttemptDetails('${attempt.id}', '${passageId}', false)" style="margin-top: 10px; font-size: 12px; padding: 6px 12px;">
                                View Details
                            </button>
                        </div>
                    `;
                });
                
                attemptsHTML += '</div>';
                
                // Create and show modal
                const modal = document.createElement('div');
                modal.className = 'modal active';
                modal.innerHTML = `
                    <div class="modal-content" style="max-width: 600px;">
                        <h2>Attempt History</h2>
                        ${attemptsHTML}
                        <button class="btn btn-secondary" onclick="this.closest('.modal').remove()" style="margin-top: 20px; width: 100%;">Close</button>
                    </div>
                `;
                document.body.appendChild(modal);
                
                // Close on outside click
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        modal.remove();
                    }
                });
                
            } catch (error) {
                console.error('Failed to load attempt history:', error);
                alert('Network error. Please try again.');
            }
        }
        
        async function showWritingSectionAttemptHistory(writingSectionId) {
            if (!authToken) {
                alert('Please log in to view your attempt history.');
                return;
            }
            
            try {
                const url = `${API_BASE}/progress/writing-sections/${writingSectionId}/attempts`;
                console.log('Fetching writing section attempt history from:', url);
                
                const response = await fetch(url, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                console.log('Response status:', response.status);
                
                if (!response.ok) {
                    let errorMessage = 'Please try again.';
                    try {
                        const errorData = await response.json();
                        console.error('Error response:', errorData);
                        errorMessage = errorData.error?.message || errorMessage;
                    } catch (e) {
                        console.error('Failed to parse error response:', e);
                        errorMessage = `HTTP ${response.status}: ${response.statusText}`;
                    }
                    alert(`Failed to load attempt history. ${errorMessage}`);
                    return;
                }
                
                const attempts = await response.json();
                
                if (attempts.length === 0) {
                    alert('No attempts found for this writing section. Try refreshing the page.');
                    return;
                }
                
                // Show attempts in a modal
                let attemptsHTML = '<div style="max-height: 70vh; overflow-y: auto;">';
                attemptsHTML += `<h3 style="margin-bottom: 20px; color: #3498DB;">Attempt History</h3>`;
                
                attempts.forEach((attempt, index) => {
                    const date = new Date(attempt.completed_at);
                    const dateStr = date.toLocaleString();
                    const percentage = Math.round((attempt.correct_count / attempt.total_questions) * 100);
                    
                    attemptsHTML += `
                        <div style="border: 1px solid #d0d0d0; border-radius: 8px; padding: 15px; margin-bottom: 15px; background: white;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                <strong style="color: #000;">Attempt #${attempts.length - index}</strong>
                                <span style="color: #666; font-size: 12px;">${dateStr}</span>
                            </div>
                            <div style="color: #000; margin-bottom: 8px;">
                                Score: <strong style="color: #3498DB;">${attempt.correct_count} / ${attempt.total_questions} (${percentage}%)</strong>
                            </div>
                            ${attempt.time_spent_seconds ? `<div style="color: #666; font-size: 12px;">Time: ${Math.floor(attempt.time_spent_seconds / 60)}m ${attempt.time_spent_seconds % 60}s</div>` : ''}
                            <button class="btn btn-secondary" onclick="viewAttemptDetails('${attempt.id}', '${writingSectionId}', true)" style="margin-top: 10px; font-size: 12px; padding: 6px 12px;">
                                View Details
                            </button>
                        </div>
                    `;
                });
                
                attemptsHTML += '</div>';
                
                // Create and show modal
                const modal = document.createElement('div');
                modal.className = 'modal active';
                modal.innerHTML = `
                    <div class="modal-content" style="max-width: 600px;">
                        <h2>Attempt History</h2>
                        ${attemptsHTML}
                        <button class="btn btn-secondary" onclick="this.closest('.modal').remove()" style="margin-top: 20px; width: 100%;">Close</button>
                    </div>
                `;
                document.body.appendChild(modal);
                
                // Close on outside click
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        modal.remove();
                    }
                });
                
            } catch (error) {
                console.error('Failed to load attempt history:', error);
                alert('Network error. Please try again.');
            }
        }
        
        async function viewAttemptDetails(attemptId, sectionId, isWritingSection = false) {
            // Load section and attempt data to show full details
            try {
                const endpoint = isWritingSection ? `${API_BASE}/writing-sections/${sectionId}` : `${API_BASE}/passages/${sectionId}`;
                const attemptsEndpoint = isWritingSection 
                    ? `${API_BASE}/progress/writing-sections/${sectionId}/attempts`
                    : `${API_BASE}/progress/passages/${sectionId}/attempts`;
                
                const [sectionResponse, attemptsResponse] = await Promise.all([
                    fetch(endpoint, {
                        headers: authToken ? {'Authorization': `Bearer ${authToken}`} : {}
                    }),
                    fetch(attemptsEndpoint, {
                        headers: {'Authorization': `Bearer ${authToken}`}
                    })
                ]);
                
                if (!sectionResponse.ok || !attemptsResponse.ok) {
                    alert('Failed to load attempt details.');
                    return;
                }
                
                const sectionData = await sectionResponse.json();
                const attempts = await attemptsResponse.json();
                const attempt = attempts.find(a => a.id === attemptId);
                
                if (!attempt) {
                    alert('Attempt not found.');
                    return;
                }
                
                // Show attempt details in a modal
                const date = new Date(attempt.completed_at);
                const dateStr = date.toLocaleString();
                const percentage = Math.round((attempt.correct_count / attempt.total_questions) * 100);
                
                let detailsHTML = `
                    <div style="max-height: 80vh; overflow-y: auto;">
                        <h3 style="margin-bottom: 15px; color: #3498DB;">Attempt Details</h3>
                        <div style="background: #f9f9f9; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                            <div style="margin-bottom: 8px;"><strong>Date:</strong> ${dateStr}</div>
                            <div style="margin-bottom: 8px;"><strong>Score:</strong> ${attempt.correct_count} / ${attempt.total_questions} (${percentage}%)</div>
                            ${attempt.time_spent_seconds ? `<div><strong>Time:</strong> ${Math.floor(attempt.time_spent_seconds / 60)}m ${attempt.time_spent_seconds % 60}s</div>` : ''}
                        </div>
                        <h4 style="margin-bottom: 15px; color: #000;">Your Answers:</h4>
                `;
                
                // Match attempt answers with section questions
                const questions = sectionData.questions || [];
                questions.forEach((question, index) => {
                    const attemptAnswer = attempt.answers.find(a => a.question_id === question.id);
                    if (!attemptAnswer) return;
                    
                    const isCorrect = attemptAnswer.is_correct;
                    const questionNumber = question.order !== undefined ? question.order : (index + 1);
                    
                    // Get options - handle both array of strings and array of objects
                    const options = question.options || [];
                    
                    detailsHTML += `
                        <div class="question-card" style="margin-bottom: 15px;">
                            <h4>Question ${questionNumber} ${isCorrect ? '‚úì' : '‚úó'}</h4>
                            <p style="margin-bottom: 10px; font-size: 14px; color: #000;">${question.text}</p>
                            <div class="options-container">
                                ${options.map((option, optIndex) => {
                                    let optionClass = 'option';
                                    if (optIndex === question.correct_answer_index) {
                                        optionClass += ' correct';
                                    } else if (optIndex === attemptAnswer.selected_option_index && !isCorrect) {
                                        optionClass += ' incorrect';
                                    }
                                    
                                    const optionText = typeof option === 'string' ? option : option.text;
                                    
                                    return `
                                        <div class="${optionClass}" style="pointer-events: none;">
                                            <input type="radio" disabled ${optIndex === attemptAnswer.selected_option_index ? 'checked' : ''}>
                                            <label class="option-label">
                                                ${String.fromCharCode(65 + optIndex)}. ${optionText}
                                                ${optIndex === question.correct_answer_index ? ' (Correct)' : ''}
                                                ${optIndex === attemptAnswer.selected_option_index && !isCorrect ? ' (Your Answer)' : ''}
                                            </label>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                            ${attemptAnswer.explanation ? `
                                <div class="explanation" style="margin-top: 10px;">
                                    <strong>Explanation:</strong> ${attemptAnswer.explanation}
                                </div>
                            ` : ''}
                        </div>
                    `;
                });
                
                detailsHTML += '</div>';
                
                // Create and show modal
                const modal = document.createElement('div');
                modal.className = 'modal active';
                modal.innerHTML = `
                    <div class="modal-content" style="max-width: 700px;">
                        ${detailsHTML}
                        <button class="btn btn-secondary" onclick="this.closest('.modal').remove()" style="margin-top: 20px; width: 100%;">Close</button>
                    </div>
                `;
                document.body.appendChild(modal);
                
                // Close on outside click
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        modal.remove();
                    }
                });
                
            } catch (error) {
                console.error('Failed to load attempt details:', error);
                alert('Network error. Please try again.');
            }
        }
        
        async function upgradeToPremium() {
            if (!authToken) {
                alert('Please login first');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/payments/checkout`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                
                if (response.ok && data.url) {
                    window.location.href = data.url;
                } else {
                    alert('Failed to create checkout session. Please try again.');
                }
            } catch (error) {
                console.error('Failed to create checkout:', error);
                alert('Network error. Please try again.');
            }
        }
        
        function updateUI() {
            if (currentUser) {
                document.getElementById('authSection').classList.add('hidden');
                document.getElementById('userInfo').classList.remove('hidden');
                document.getElementById('userEmail').textContent = currentUser.email;
                
                if (currentUser.is_premium) {
                    document.getElementById('subscriptionStatus').textContent = 'Premium Active';
                    document.querySelector('#subscriptionInfo button').textContent = 'Manage Subscription';
                    document.querySelector('#subscriptionInfo button').onclick = manageSubscription;
                } else {
                    document.getElementById('subscriptionStatus').textContent = 'Free';
                }
            } else {
                document.getElementById('authSection').classList.remove('hidden');
                document.getElementById('userInfo').classList.add('hidden');
            }
        }
        
        async function manageSubscription() {
            if (!authToken) return;
            
            try {
                const response = await fetch(`${API_BASE}/payments/portal`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                
                if (response.ok && data.url) {
                    window.location.href = data.url;
                }
            } catch (error) {
                console.error('Failed to open portal:', error);
            }
        }
        
        function logout() {
            localStorage.removeItem('authToken');
            authToken = null;
            currentUser = null;
            updateUI();
            loadPassages();
        }
        
        function showLoginModal() {
            document.getElementById('loginModal').classList.add('active');
            document.getElementById('loginError').textContent = '';
        }
        
        function showRegisterModal() {
            document.getElementById('registerModal').classList.add('active');
            document.getElementById('registerError').textContent = '';
        }
        
        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }
        
        async function loadWordOfDay() {
            try {
                const response = await fetch(`${API_BASE}/word-of-the-day`);
                if (response.ok) {
                    const data = await response.json();
                    displayWordOfDay(data);
                } else {
                    document.getElementById('wordOfDay').innerHTML = `
                        <h3>Word of the Day</h3>
                        <div class="loading">Unable to load word of the day</div>
                    `;
                }
            } catch (error) {
                console.error('Failed to load word of day:', error);
                document.getElementById('wordOfDay').innerHTML = `
                    <h3>Word of the Day</h3>
                    <div class="loading">Unable to load word of the day</div>
                `;
            }
        }
        
        function displayWordOfDay(data) {
            const synonyms = data.synonyms || [];
            const synonymTags = synonyms.map(syn => 
                `<span class="synonym-tag">${syn}</span>`
            ).join('');
            
            document.getElementById('wordOfDay').innerHTML = `
                <h3>Word of the Day</h3>
                <div class="word">${data.word}</div>
                <div class="definition">${data.definition}</div>
                ${synonyms.length > 0 ? `
                    <div class="synonyms">
                        <div class="synonyms-label">Synonyms:</div>
                        <div class="synonym-tags">${synonymTags}</div>
                    </div>
                ` : ''}
                <div class="example">
                    <div class="example-label">Example:</div>
                    <div class="example-sentence">"${data.example_sentence}"</div>
                </div>
            `;
        }
        
        // Close modal on outside click
        document.querySelectorAll('.modal').forEach(modal => {
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.classList.remove('active');
                }
            });
        });
    </script>
</body>
</html>


